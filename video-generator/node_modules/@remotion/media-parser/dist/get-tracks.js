"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getTracks = exports.getTracksFromIsoBaseMedia = exports.getHasTracks = exports.isoBaseMediaHasTracks = exports.getNumberOfTracks = void 0;
const make_track_1 = require("./containers/iso-base-media/make-track");
const traversal_1 = require("./containers/iso-base-media/traversal");
const get_tracks_from_mp3_1 = require("./containers/mp3/get-tracks-from-mp3");
const get_tracks_from_avi_1 = require("./containers/riff/get-tracks-from-avi");
const get_tracks_1 = require("./containers/transport-stream/get-tracks");
const get_ready_tracks_1 = require("./containers/webm/get-ready-tracks");
const traversal_2 = require("./containers/webm/traversal");
const getNumberOfTracks = (moovBox) => {
    const mvHdBox = (0, traversal_1.getMvhdBox)(moovBox);
    if (!mvHdBox) {
        return 0;
    }
    return mvHdBox.nextTrackId - 1;
};
exports.getNumberOfTracks = getNumberOfTracks;
const isoBaseMediaHasTracks = (state) => {
    return Boolean((0, traversal_1.getMoovBox)(state));
};
exports.isoBaseMediaHasTracks = isoBaseMediaHasTracks;
const getHasTracks = (state) => {
    const structure = state.getStructure();
    if (structure.type === 'matroska') {
        const mainSegment = (0, traversal_2.getMainSegment)(structure.boxes);
        if (!mainSegment) {
            return false;
        }
        return (0, traversal_2.getTracksSegment)(mainSegment) !== null;
    }
    if (structure.type === 'iso-base-media') {
        return (0, exports.isoBaseMediaHasTracks)(state);
    }
    if (structure.type === 'riff') {
        return (0, get_tracks_from_avi_1.hasAllTracksFromAvi)(state);
    }
    if (structure.type === 'transport-stream') {
        return (0, get_tracks_1.hasAllTracksFromTransportStream)(state);
    }
    if (structure.type === 'mp3') {
        return state.callbacks.tracks.getTracks().length > 0;
    }
    if (structure.type === 'wav') {
        return state.callbacks.tracks.hasAllTracks();
    }
    if (structure.type === 'aac') {
        return state.callbacks.tracks.hasAllTracks();
    }
    if (structure.type === 'flac') {
        return state.callbacks.tracks.hasAllTracks();
    }
    throw new Error('Unknown container ' + structure);
};
exports.getHasTracks = getHasTracks;
const getTracksFromMa = (segments, state) => {
    const videoTracks = [];
    const audioTracks = [];
    const otherTracks = [];
    const mainSegment = segments.find((s) => s.type === 'Segment');
    if (!mainSegment) {
        throw new Error('No main segment found');
    }
    const matroskaTracks = (0, get_ready_tracks_1.getTracksFromMatroska)(mainSegment, state.webm.getTimescale());
    for (const track of matroskaTracks) {
        if (track.type === 'video') {
            videoTracks.push(track);
        }
        else if (track.type === 'audio') {
            audioTracks.push(track);
        }
        else if (track.type === 'other') {
            otherTracks.push(track);
        }
    }
    return {
        videoTracks,
        audioTracks,
        otherTracks,
    };
};
const getTracksFromIsoBaseMedia = (state) => {
    const videoTracks = [];
    const audioTracks = [];
    const otherTracks = [];
    const moovBox = (0, traversal_1.getMoovBox)(state);
    if (!moovBox) {
        return {
            videoTracks,
            audioTracks,
            otherTracks,
        };
    }
    const tracks = (0, traversal_1.getTraks)(moovBox);
    for (const trakBox of tracks) {
        const track = (0, make_track_1.makeBaseMediaTrack)(trakBox);
        if (!track) {
            continue;
        }
        if (track.type === 'video') {
            videoTracks.push(track);
        }
        else if (track.type === 'audio') {
            audioTracks.push(track);
        }
        else if (track.type === 'other') {
            otherTracks.push(track);
        }
    }
    return {
        videoTracks,
        audioTracks,
        otherTracks,
    };
};
exports.getTracksFromIsoBaseMedia = getTracksFromIsoBaseMedia;
const getTracks = (state) => {
    const structure = state.getStructure();
    if (structure.type === 'matroska') {
        return getTracksFromMa(structure.boxes, state);
    }
    if (structure.type === 'iso-base-media') {
        return (0, exports.getTracksFromIsoBaseMedia)(state);
    }
    if (structure.type === 'riff') {
        return (0, get_tracks_from_avi_1.getTracksFromAvi)(structure, state);
    }
    if (structure.type === 'transport-stream') {
        return (0, get_tracks_1.getTracksFromTransportStream)(state);
    }
    if (structure.type === 'mp3' ||
        structure.type === 'wav' ||
        structure.type === 'flac' ||
        structure.type === 'aac') {
        return (0, get_tracks_from_mp3_1.getTracksFromMp3OrWavOrAac)(state);
    }
    throw new Error(`Unknown container${structure}`);
};
exports.getTracks = getTracks;
